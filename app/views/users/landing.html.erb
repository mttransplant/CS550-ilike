<% provide(:title, full_name(@user)) %>
<div class="alert alert-info" role="alert"><b>Welcome! <%= full_name(@user) %></b>, here are few places you might wanna check out</div>
<div class="row">
   <div id = "eventlist" class="col-sm-4">
      Lorem ipsum accumsan porta libero dapibus suscipit convallis phasellus vulputate, luctus primis viverra egestas tempor bibendum ac egestas, ad faucibus donec auctor conubia malesuada sem fermentum ad consectetur vel nostra ultrices orci elementum elit varius.
      Praesent litora ante integer pellentesque tempus sagittis ad nisl fusce pulvinar, euismod etiam metus libero eu mollis vel in congue, nec velit eleifend senectus iaculis in arcu metus potenti ullamcorper suscipit vestibulum class.
      Aliquam purus euismod aptent per rutrum euismod consequat magna sit taciti justo, semper bibendum mi rhoncus venenatis vitae sagittis vel eros per vehicula posuere etiam elit interdum turpis.
      Vehicula condimentum euismod tempor consequat nunc luctus inceptos, adipiscing hac donec eget dictum quisque euismod ornare, erat quis vitae nisi pulvinar eget adipiscing consectetur fames auctor elit ornare sollicitudin volutpat sollicitudin hac.
      Vestibulum lectus elit curabitur at conubia diam feugiat lorem nullam massa hac aenean curabitur platea, tempor sodales habitasse senectus taciti consequat platea ut tempor congue volutpat etiam vulputate.Lorem ipsum accumsan porta libero dapibus suscipit convallis phasellus vulputate, luctus primis viverra egestas tempor bibendum ac egestas, ad faucibus donec auctor conubia malesuada sem fermentum ad consectetur vel nostra ultrices orci elementum elit varius.
      Praesent litora ante integer pellentesque tempus sagittis ad nisl fusce pulvinar, euismod etiam metus libero eu mollis vel in congue, nec velit eleifend senectus iaculis in arcu metus potenti ullamcorper suscipit vestibulum class.
      Aliquam purus euismod aptent per rutrum euismod consequat magna sit taciti justo, semper bibendum mi rhoncus venenatis vitae sagittis vel eros per vehicula posuere etiam elit interdum turpis.
      Vehicula condimentum euismod tempor consequat nunc luctus inceptos, adipiscing hac donec eget dictum quisque euismod ornare, erat quis vitae nisi pulvinar eget adipiscing consectetur fames auctor elit ornare sollicitudin volutpat sollicitudin hac.
      Vestibulum lectus elit curabitur at conubia diam feugiat lorem nullam massa hac aenean curabitur platea, tempor sodales habitasse senectus taciti consequat platea ut tempor congue volutpat etiam vulputate.Lorem ipsum accumsan porta libero dapibus suscipit convallis phasellus vulputate, luctus primis viverra egestas tempor bibendum ac egestas, ad faucibus donec auctor conubia malesuada sem fermentum ad consectetur vel nostra ultrices orci elementum elit varius.
      Praesent litora ante integer pellentesque tempus sagittis ad nisl fusce pulvinar, euismod etiam metus libero eu mollis vel in congue, nec velit eleifend senectus iaculis in arcu metus potenti ullamcorper suscipit vestibulum class.
      Aliquam purus euismod aptent per rutrum euismod consequat magna sit taciti justo, semper bibendum mi rhoncus venenatis vitae sagittis vel eros per vehicula posuere etiam elit interdum turpis.
      Vehicula condimentum euismod tempor consequat nunc luctus inceptos, adipiscing hac donec eget dictum quisque euismod ornare, erat quis vitae nisi pulvinar eget adipiscing consectetur fames auctor elit ornare sollicitudin volutpat sollicitudin hac.
      Vestibulum lectus elit curabitur at conubia diam feugiat lorem nullam massa hac aenean curabitur platea, tempor sodales habitasse senectus taciti consequat platea ut tempor congue volutpat etiam vulputate.Lorem ipsum accumsan porta libero dapibus suscipit convallis phasellus vulputate, luctus primis viverra egestas tempor bibendum ac egestas, ad faucibus donec auctor conubia malesuada sem fermentum ad consectetur vel nostra ultrices orci elementum elit varius.
      Praesent litora ante integer pellentesque tempus sagittis ad nisl fusce pulvinar, euismod etiam metus libero eu mollis vel in congue, nec velit eleifend senectus iaculis in arcu metus potenti ullamcorper suscipit vestibulum class.
      Aliquam purus euismod aptent per rutrum euismod consequat magna sit taciti justo, semper bibendum mi rhoncus venenatis vitae sagittis vel eros per vehicula posuere etiam elit interdum turpis.
      Vehicula condimentum euismod tempor consequat nunc luctus inceptos, adipiscing hac donec eget dictum quisque euismod ornare, erat quis vitae nisi pulvinar eget adipiscing consectetur fames auctor elit ornare sollicitudin volutpat sollicitudin hac.
      Vestibulum lectus elit curabitur at conubia diam feugiat lorem nullam massa hac aenean curabitur platea, tempor sodales habitasse senectus taciti consequat platea ut tempor congue volutpat etiam vulputate.Lorem ipsum accumsan porta libero dapibus suscipit convallis phasellus vulputate, luctus primis viverra egestas tempor bibendum ac egestas, ad faucibus donec auctor conubia malesuada sem fermentum ad consectetur vel nostra ultrices orci elementum elit varius.
      Praesent litora ante integer pellentesque tempus sagittis ad nisl fusce pulvinar, euismod etiam metus libero eu mollis vel in congue, nec velit eleifend senectus iaculis in arcu metus potenti ullamcorper suscipit vestibulum class.
      Aliquam purus euismod aptent per rutrum euismod consequat magna sit taciti justo, semper bibendum mi rhoncus venenatis vitae sagittis vel eros per vehicula posuere etiam elit interdum turpis.
      Vehicula condimentum euismod tempor consequat nunc luctus inceptos, adipiscing hac donec eget dictum quisque euismod ornare, erat quis vitae nisi pulvinar eget adipiscing consectetur fames auctor elit ornare sollicitudin volutpat sollicitudin hac.
      Vestibulum lectus elit curabitur at conubia diam feugiat lorem nullam massa hac aenean curabitur platea, tempor sodales habitasse senectus taciti consequat platea ut tempor congue volutpat etiam vulputate.Lorem ipsum accumsan porta libero dapibus suscipit convallis phasellus vulputate, luctus primis viverra egestas tempor bibendum ac egestas, ad faucibus donec auctor conubia malesuada sem fermentum ad consectetur vel nostra ultrices orci elementum elit varius.
      Praesent litora ante integer pellentesque tempus sagittis ad nisl fusce pulvinar, euismod etiam metus libero eu mollis vel in congue, nec velit eleifend senectus iaculis in arcu metus potenti ullamcorper suscipit vestibulum class.
      Aliquam purus euismod aptent per rutrum euismod consequat magna sit taciti justo, semper bibendum mi rhoncus venenatis vitae sagittis vel eros per vehicula posuere etiam elit interdum turpis.
      Vehicula condimentum euismod tempor consequat nunc luctus inceptos, adipiscing hac donec eget dictum quisque euismod ornare, erat quis vitae nisi pulvinar eget adipiscing consectetur fames auctor elit ornare sollicitudin volutpat sollicitudin hac.
      Vestibulum lectus elit curabitur at conubia diam feugiat lorem nullam massa hac aenean curabitur platea, tempor sodales habitasse senectus taciti consequat platea ut tempor congue volutpat etiam vulputate.Lorem ipsum accumsan porta libero dapibus suscipit convallis phasellus vulputate, luctus primis viverra egestas tempor bibendum ac egestas, ad faucibus donec auctor conubia malesuada sem fermentum ad consectetur vel nostra ultrices orci elementum elit varius.
      Praesent litora ante integer pellentesque tempus sagittis ad nisl fusce pulvinar, euismod etiam metus libero eu mollis vel in congue, nec velit eleifend senectus iaculis in arcu metus potenti ullamcorper suscipit vestibulum class.
      Aliquam purus euismod aptent per rutrum euismod consequat magna sit taciti justo, semper bibendum mi rhoncus venenatis vitae sagittis vel eros per vehicula posuere etiam elit interdum turpis.
      Vehicula condimentum euismod tempor consequat nunc luctus inceptos, adipiscing hac donec eget dictum quisque euismod ornare, erat quis vitae nisi pulvinar eget adipiscing consectetur fames auctor elit ornare sollicitudin volutpat sollicitudin hac.
      Vestibulum lectus elit curabitur at conubia diam feugiat lorem nullam massa hac aenean curabitur platea, tempor sodales habitasse senectus taciti consequat platea ut tempor congue volutpat etiam vulputate.Lorem ipsum accumsan porta libero dapibus suscipit convallis phasellus vulputate, luctus primis viverra egestas tempor bibendum ac egestas, ad faucibus donec auctor conubia malesuada sem fermentum ad consectetur vel nostra ultrices orci elementum elit varius.
      Praesent litora ante integer pellentesque tempus sagittis ad nisl fusce pulvinar, euismod etiam metus libero eu mollis vel in congue, nec velit eleifend senectus iaculis in arcu metus potenti ullamcorper suscipit vestibulum class.
      Aliquam purus euismod aptent per rutrum euismod consequat magna sit taciti justo, semper bibendum mi rhoncus venenatis vitae sagittis vel eros per vehicula posuere etiam elit interdum turpis.
      Vehicula condimentum euismod tempor consequat nunc luctus inceptos, adipiscing hac donec eget dictum quisque euismod ornare, erat quis vitae nisi pulvinar eget adipiscing consectetur fames auctor elit ornare sollicitudin volutpat sollicitudin hac.
      Vestibulum lectus elit curabitur at conubia diam feugiat lorem nullam massa hac aenean curabitur platea, tempor sodales habitasse senectus taciti consequat platea ut tempor congue volutpat etiam vulputate.Lorem ipsum accumsan porta libero dapibus suscipit convallis phasellus vulputate, luctus primis viverra egestas tempor bibendum ac egestas, ad faucibus donec auctor conubia malesuada sem fermentum ad consectetur vel nostra ultrices orci elementum elit varius.
      Praesent litora ante integer pellentesque tempus sagittis ad nisl fusce pulvinar, euismod etiam metus libero eu mollis vel in congue, nec velit eleifend senectus iaculis in arcu metus potenti ullamcorper suscipit vestibulum class.
      Aliquam purus euismod aptent per rutrum euismod consequat magna sit taciti justo, semper bibendum mi rhoncus venenatis vitae sagittis vel eros per vehicula posuere etiam elit interdum turpis.
      Vehicula condimentum euismod tempor consequat nunc luctus inceptos, adipiscing hac donec eget dictum quisque euismod ornare, erat quis vitae nisi pulvinar eget adipiscing consectetur fames auctor elit ornare sollicitudin volutpat sollicitudin hac.
      Vestibulum lectus elit curabitur at conubia diam feugiat lorem nullam massa hac aenean curabitur platea, tempor sodales habitasse senectus taciti consequat platea ut tempor congue volutpat etiam vulputate.Lorem ipsum accumsan porta libero dapibus suscipit convallis phasellus vulputate, luctus primis viverra egestas tempor bibendum ac egestas, ad faucibus donec auctor conubia malesuada sem fermentum ad consectetur vel nostra ultrices orci elementum elit varius.
      Praesent litora ante integer pellentesque tempus sagittis ad nisl fusce pulvinar, euismod etiam metus libero eu mollis vel in congue, nec velit eleifend senectus iaculis in arcu metus potenti ullamcorper suscipit vestibulum class.
      Aliquam purus euismod aptent per rutrum euismod consequat magna sit taciti justo, semper bibendum mi rhoncus venenatis vitae sagittis vel eros per vehicula posuere etiam elit interdum turpis.
      Vehicula condimentum euismod tempor consequat nunc luctus inceptos, adipiscing hac donec eget dictum quisque euismod ornare, erat quis vitae nisi pulvinar eget adipiscing consectetur fames auctor elit ornare sollicitudin volutpat sollicitudin hac.
      Vestibulum lectus elit curabitur at conubia diam feugiat lorem nullam massa hac aenean curabitur platea, tempor sodales habitasse senectus taciti consequat platea ut tempor congue volutpat etiam vulputate.Lorem ipsum accumsan porta libero dapibus suscipit convallis phasellus vulputate, luctus primis viverra egestas tempor bibendum ac egestas, ad faucibus donec auctor conubia malesuada sem fermentum ad consectetur vel nostra ultrices orci elementum elit varius.
      Praesent litora ante integer pellentesque tempus sagittis ad nisl fusce pulvinar, euismod etiam metus libero eu mollis vel in congue, nec velit eleifend senectus iaculis in arcu metus potenti ullamcorper suscipit vestibulum class.
      Aliquam purus euismod aptent per rutrum euismod consequat magna sit taciti justo, semper bibendum mi rhoncus venenatis vitae sagittis vel eros per vehicula posuere etiam elit interdum turpis.
      Vehicula condimentum euismod tempor consequat nunc luctus inceptos, adipiscing hac donec eget dictum quisque euismod ornare, erat quis vitae nisi pulvinar eget adipiscing consectetur fames auctor elit ornare sollicitudin volutpat sollicitudin hac.
      Vestibulum lectus elit curabitur at conubia diam feugiat lorem nullam massa hac aenean curabitur platea, tempor sodales habitasse senectus taciti consequat platea ut tempor congue volutpat etiam vulputate.
   </div>
   
   <div class="col-sm-8">
      <div id="over_map">
         <div class="col-lg-5">
            <div class="input-group">
               <input id ="new-loc" type="text" class="form-control" placeholder="Change current location">
               <span class="input-group-btn">
                  <button class="btn btn-primary" type="button" onclick="changeAddress()">
                     Go!
                  </button>
                  </span>
            </div><!-- /input-group -->
         </div><!-- /.col-lg-6 -->
      </div>

      <div id="geolocation"></div>
   </div>
</div>

<script type="text/javascript">

   var currentDisplayLat;
   var currentDisplayLng;
   var map;
   var markers = new Array();
   var visible_markers = new Array();
   var favorite_categories = <%= raw @user.categories.collect { |category| category.category_id } %>

   var oArgs; 

// The function checks if the browser supports Geolocation feature
function initialize() {
   
   if (navigator.geolocation){
      navigator.geolocation.getCurrentPosition(showCurrentPosition);
   }else{
      
      alert("Whoopie! Your browser is ancient. Geolocation not supported")
   }
}

// The function displays the current location of the user on the map
function showCurrentPosition(position) {
   
   currentDisplayLat = position.coords.latitude;
   currentDisplayLng = position.coords.longitude;

   var myLoc = new google.maps.LatLng(currentDisplayLat,currentDisplayLng);
   
   mapProp = {
         center:myLoc,
         zoom:12,
         mapTypeId:google.maps.MapTypeId.ROADMAP
      };
   
   map = new google.maps.Map(document.getElementById("geolocation"),mapProp);
   
   var marker = new google.maps.Marker({
      
      position:myLoc,
      animation:google.maps.Animation.BOUNCE
      
   });
   
   var infowindow = new google.maps.InfoWindow({
    
    content:"You're here"
      
   });
  
  google.maps.event.addListener(marker, 'click', function() {
    infowindow.open(map,marker);
    
  });
  markers.push(marker);
  findEvents(currentDisplayLat, currentDisplayLng);
} //End Function

// This function searches on eventful for user-preferred category of events
function findEvents(lat, lng){
   
   var lat_string = lat.toString();
   var lng_string = lng.toString();
   var where_list = lat_string + "," +lng_string;
   
   oArgs = {
      app_key: "JzrwKVnwSjCSjD9x",
      category: favorite_categories,
      where: (where_list), 
      page_size: 20,
      sort_order:"popularity",
      within: 10,
      date: "This Week",
      units: "km",
   };
   EVDB.API.URL = "https://api.eventful.com/json";
   EVDB.API.call("/events/search", oArgs, displayEvents);
}

// This function displays the filtered events on the map
function displayEvents(filtered_events){
   console.log(filtered_events);
   
   var event_count = filtered_events.events.event.length;
   
   for(i = 0; i<event_count; i++){
      
      var tempEvent = filtered_events.events.event[i];
      var eventTitle = tempEvent.title;
      var eventLoc = new google.maps.LatLng(Number(tempEvent.latitude),Number(tempEvent.longitude));
      
      var thisinfowindow = new google.maps.InfoWindow({
        content:eventTitle
        
      });
      
      var marker = new google.maps.Marker({
        position: eventLoc,
        title: eventTitle,
        infowindow: thisinfowindow
        
      });
      
      google.maps.event.addListener(marker, 'click', function() {
        
        this.infowindow.open(map,this);
        
      });
      
      markers.push(marker);
    }
    placeMarkers();
} // End function

// This function is to clear all the markers
function clearMarkers(){
   for (var i = 0; i < markers.length; i++) {
     markers[i].setMap(null);
      
   }
   markers = [];
}

// This function is to place all the markers
function placeMarkers(){
   for (var i = 0; i < markers.length; i++) {
      markers[i].setMap(map);
   }
}
// This function displays the events of a new location given by the user
function changeAddress(){
   
   clearMarkers();
   
   
   var newLocation = document.getElementById("new-loc").value;
   
   var geocoder = new google.maps.Geocoder();
   
   
   geocoder.geocode( {address: newLocation}, function(results, status){
      
      if (status == google.maps.GeocoderStatus.OK){
         
         map.setCenter(results[0].geometry.location);
         
         var marker = new google.maps.Marker({
            position: results[0].geometry.location,
            
            animation:google.maps.Animation.BOUNCE
         });
         
         findEvents(results[0].geometry.location.lat(), results[0].geometry.location.lng());
         markers.push(marker);
         placeMarkers();
      } else {
         
         alert('Geocode was not successful because: ' + status);
         
      }
      
   })
   
   
   
} //End Function


google.maps.event.addDomListener(window, 'load', initialize);


</script>

